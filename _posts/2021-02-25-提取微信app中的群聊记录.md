## 背景

今天接到一个需求是获取微信的群聊记录。先前在做公众号文章链接获取的时候，发现Android微信app本地含有众多的数据库，其中`EnMicroMsg.db`中存储了大量和聊天相关的表，于是选择这个方案快速地解决问题

## 代码实践

首先执行adb指令将手机端本地的数据库拉取下来

```python
def get_db(device_id):
    """
    device_id为adb devices中的id
    """
    db_path = adb.cmd(['shell', 'su', '-c', '"cd /data/data/com.tencent.mm/MicroMsg && find -mtime -1 -name FinderMM029.db"'])  # 找到最近有读写记录的账号目录
    real_path = '/data/data/com.tencent.mm/MicroMsg' + db_path.strip().replace('.', '', 1)  # 找到db的绝对路径
    adb.cmd(['shell', 'su', '-c', '"cp {} /sdcard/EnMicroMsg.db"'.format(real_path)])  # 复制到sdcard目录
    adb.pull('/sdcard/EnMicroMsg.db', device_id)  # 拉取EnMicroMsg.db到本地
```

接着发现这个数据库是基于[sqlcipher](https://github.com/sqlcipher/sqlcipher)完成对sqlite的加密。比较关键的点是获取到它的密钥，通过逆向发现是获取到了手机的imei和微信号的uin组合在一起做md5，取前7位字符串

以下是生成解密密钥的代码

```python
def get_imei():
    entry = adb.cmd(['shell', 'su', '-c', '"grep IMEI_DENGTA /data/data/com.tencent.mm/shared_prefs/beacontbs_DENGTA_META.xml"'])  # 获取微信记录的imei
    return entry.split('>')[1].split('<')[0]

def get_uin():
    entry = adb.cmd(['shell', 'su', '-c', '"grep _auth_uin /data/data/com.tencent.mm/shared_prefs/auth_info_key_prefs.xml"'])  # 获取微信号的uin
    return entry.split(' value="')[1].split('"')[0]
    
def cal_key(uin, imei):
    return hashlib.md5((imei+uin).encode()).hexdigest()[:7]
```

获取到key之后，即可对`EnMicroMsg.db`解密。这里需要安装一下sqlcipher，通过执行以下代码即可转化为正常的sqlite3数据库

```python
def decrypt_db(key, sqlcipher_path, db_path):
    """
    传入解密密钥和EnMicroMsg.db的路径
    """
    sql = "PRAGMA key = '{key}'; PRAGMA kdf_iter = 4000; PRAGMA cipher_use_hmac = OFF; PRAGMA cipher_page_size = 1024; ATTACH DATABASE '{key}.db' AS plaintext KEY ''; SELECT sqlcipher_export('plaintext'); DETACH DATABASE plaintext;".format(key=key)
    cmd = 'echo "{}" | {} {}'.format(sql, sqlcipher_path, db_path)
    subprocess.run([cmd], shell=True)
```

这样即可运行sqlite3加上解密后的数据库地址，正常查看数据了。有几个比较关键的表`chatroom`记录群聊列表，`message`记录聊天记录。先执行一下sql获取到群聊列表

```
sqlite> .schema chatroom
CREATE TABLE chatroom (  chatroomname TEXT default ''  PRIMARY KEY ,  addtime LONG,  memberlist TEXT,  displayname TEXT,  chatroomnick TEXT,  roomflag INTEGER,  roomowner TEXT,  roomdata BLOB,  isShowname INTEGER,  selfDisplayName TEXT,  style INTEGER,  chatroomdataflag INTEGER,  modifytime LONG,  chatroomnotice TEXT,  chatroomVersion INTEGER,  chatroomnoticeEditor TEXT,  chatroomnoticePublishTime LONG,  chatroomLocalVersion LONG,  chatroomStatus INTEGER default '0' ,  memberCount INTEGER default '-1' );
CREATE INDEX serverChatRoomUserIndex ON chatroom ( chatroomname );

sqlite> select chatroomname from chatroom limit 1;
26948416766@chatroom
```

然后通过群聊名，找到群聊记录

```
sqlite> .schema message
CREATE TABLE message ( msgId INTEGER PRIMARY KEY, msgSvrId INTEGER , type INT, status INT, isSend INT, isShowTimer INTEGER, createTime INTEGER, talker TEXT, content TEXT, imgPath TEXT, reserved TEXT, lvbuffer BLOB, transContent TEXT,transBrandWording TEXT ,talkerId INTEGER, bizClientMsgId TEXT, bizChatId INTEGER DEFAULT -1, bizChatUserId TEXT, msgSeq INTEGER, flag INT);
CREATE INDEX messageIdIndex ON message ( msgId );
CREATE INDEX messageSvrIdIndex ON message ( msgSvrId );
CREATE INDEX messageSendCreateTimeIndex ON message ( status,isSend,createTime );
CREATE INDEX messageCreateTimeIndex ON message ( createTime );
CREATE INDEX messageCreateTaklerTypeTimeIndex ON message ( talker,type,createTime );
CREATE INDEX messageTalkerStatusIndex ON message ( talker,status );
CREATE INDEX messageTalkerCreateTimeIsSendIndex ON message ( talker,isSend,createTime );
CREATE INDEX messageCreateTaklerTimeIndex ON message ( talker,createTime );
CREATE INDEX messageTalkerSvrIdIndex ON message ( talker,msgSvrId );
CREATE INDEX messageTalkerIdTypeIndex ON message ( talkerId,type );
CREATE INDEX messageTalkerTypeIndex ON message ( talker,type );
CREATE INDEX messagemessageTalkerMsgSeqIndex ON message ( talker,msgSeq );
CREATE INDEX messagemessageTalkerFlagMsgSeqIndex ON message ( talker,flag,msgSeq );

sqlite> select content from message where talker  = '26948416766@chatroom';
wxid_oxy3mw2mo2gc12:
请重新开始
wxid_lcnkf51qaaad22:
ok
wxid_lcnkf51qaaad22:
go
wxid_oxy3mw2mo2gc12:
重新开始
wxid_lcnkf51qaaad22:
ok
wxid_oxy3mw2mo2gc12:
再来
wxid_lcnkf51qaaad22:
好
wxid_oxy3mw2mo2gc12:
没问题
```

